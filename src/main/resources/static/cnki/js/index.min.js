$(function(){$("#CIDX a").on("click",function(){var m=$(".search-input").val();var l=$(".search-input").attr("placeholder");if(!!m==true&&m!=l){$(this).attr("href","//kns.cnki.net/kns/brief/default_result.aspx?code=CIDX&kw="+encodeURIComponent(m))}});var k="<a href='//ishufang.cnki.net/kpc' target='_blank'>{unit}</a>";var e='<div class="login-droplist" id="logintemplate"><span href="javascript:void(0)"><b>{namestr}</b><i></i></span><ul><li>{libhtml}</li><li><a href="javascript:void(0);" id="loginOut">退出</a></li></ul><input type="hidden" id="userid" name="userid" value=\'{uid}\' /><input type="hidden" id="username" name="username" value=\'{username}\' /><input type="hidden" id="usertype" name="usertype" value=\'{usertype}\' /></div>';function g(){var m=getUInfoFromECP("sname");var p="";var q="http://elib.cnki.net/logindigital.aspx?action=single&uid="+j()+"&p="+getUInfoFromECP("uname");var s="";var n=j();var o=getUInfoFromECP("uname");var l=getUInfoFromECP("utype");var r="";if(l&&l.toLowerCase()=="bk"){s="<a href='"+q+"' target='_blank'>我的机构馆</a>";if(m){p=p+m}else{p=p+o}r=p}else{if(l&&l.toLowerCase()=="jf"){s="<a href='"+q+"' target='_blank'>我的个人馆</a>";p=p+o;r=k.replace("{unit}",p)}}e=e.replace("{namestr}",r);e=e.replace("{libhtml}",s);e=e.replace("{uid}",n);e=e.replace("{username}",o);e=e.replace("{usertype}",l)}var f='<a class="btn-login" target="_self" href="//login.cnki.net/login/?platform=kns&ForceReLogin=1&ReturnURL=//www.cnki.net/">登录</a>';$(".login").on("click","#loginOut",function(){$.ajax({url:"//login.cnki.net/toplogin/api/loginapi/Logout?callback=?",type:"get",dataType:"jsonp",success:function(){$.cookie("Ecp_lout","1",{path:"/",domain:"cnki.net"});$(".login").html(f);$(".register").show()},error:function(){$.cookie("Ecp_lout","1",{path:"/",domain:"cnki.net"});$(".login").html(f);$(".register").show()}})});function j(){var m="";var l=GetCookie("LID");if(l){m=l}return m}function b(){var m=$("#username").val();var l=$("#usertype").val();if(m&&l){if(l=="0"){$.ajax({url:"http://my.cnki.net/leadsystem/api/leadresult/username/"+m+"?type=bk&ip=",type:"get",dataType:"jsonp",jsonp:"jsonpcallback",success:function(v){var n="";var o=v;if(v instanceof Array){o=v}else{o=JSON.parse(v)}if(!o||o.length<=0){return}var s=o[0];for(i=0;i<s.length;i++){var r=s[i].productname;var q=s[i].url;if(r&&q){var u="<p><i></i><a href='"+q+"' target='_blank'>"+r+"</a></p>";n+=u}}if(n!=""){loginCon=$("<div>").addClass("loginTanCon");$("<h2>").html("<i></i>已订购产品").append($("<em>").addClass("loginClose")).appendTo(loginCon);$("<div>").addClass("loginTxt").html(n).appendTo(loginCon);$("<span>").addClass("loginBtnClose").html("关闭").appendTo(loginCon);$("body").append(loginCon);loginCon.on("click",".loginBtnClose,.loginClose",function(p){p.preventDefault();loginCon.remove()})}},error:function(n){}})}}}$("#rollImg-1").slideBox({duration:0.5,easing:"linear",delay:5,hideClickBar:false,clickBarRadius:8});$("#rollImg-2").slideBox({duration:0.5,easing:"linear",delay:5,hideClickBar:false,clickBarRadius:8});defaultLoadPageJsonInfo();$(".search-tab").find("li").click(function(){_index=$(this).parent().find("li").index(this);$(this).parents(".wrapper").removeClass("section1 section2 section3").addClass("section"+(_index+1));$(this).addClass("on").siblings().removeClass("on");$(".banner").find("li").eq(_index).fadeIn(1000).siblings().fadeOut(1000);$(".input-box").removeClass("fullinput");if($(this).attr("val")=="doc"){$("#txt_SearchText").attr("placeholder","中文文献、外文文献")}else{if($(this).attr("val")=="ref"){$("#txt_SearchText").attr("placeholder","请输入被引文献的特征词")}else{$("#txt_SearchText").attr("placeholder","")}}if($(this).attr("val")=="ref"){$("#curdbcode").val("CRLD")}else{var l=a();if(!!l==false){if($(this).attr("val")=="ele"){$("#curdbcode").val("qa");l="qa";$(".option-list .zsy li:first").addClass("selected")}else{$("#curdbcode").val("SCDB");l="SCDB";$("#CJFQ,#CDMD,#CIPD,#CCND").addClass("selected")}}if(l.indexOf(",")>0){$("#curdbcode").val("SCDB")}else{$("#curdbcode").val(l)}if(l=="qa"){$(".input-box").addClass("fullinput");$("#txt_SearchText").attr("placeholder","请输入您的问题（支持自然语言或关键词提问，自动从文献挖掘答案）")}else{if(l=="IMAGE"){$(".input-box").addClass("fullinput");$("#txt_SearchText").attr("placeholder","图片检索，请输入关键词")}else{if(l=="CSYD"){$(".input-box").addClass("fullinput");$("#txt_SearchText").attr("placeholder",'请输入关键词，系统自动过滤特殊字符 | + %  < > & " ')}else{if(l=="METHOD"){$(".input-box").removeClass("fullinput");$("#txt_SearchText").attr("placeholder","例：情景教学法")}else{if(l=="CONC"){$(".input-box").addClass("fullinput");$("#txt_SearchText").attr("placeholder","")}}}}}}defaultLoadPageJsonInfo();inputFunc($("#txt_SearchText"))});h(".sort","cur");function h(m,l){$(m).mouseenter(function(){$selectList=$(this).find("ul");$selectList.show();$selectList.find("a").click(function(){$selectList.siblings().find("span").html($(this).text());$("#txt_sug").val($(this).text());$(this).parent().addClass(l).siblings().removeClass(l);$selectList.hide()})}).mouseleave(function(){$selectList.hide()})}$(".option-list").find("li>i").click(function(){$(this).parent().toggleClass("selected")});$("#js-gallery").royalSlider({arrowsNav:false,fadeinLoadedSlide:true,controlNavigationSpacing:0,controlNavigation:"thumbnails",thumbs:{appendSpan:true,firstMargin:true,autoCenter:true,fitInViewport:true,orientation:"vertical",spacing:0,paddingBottom:0},keyboardNavEnabled:true,imageScaleMode:"fill",imageAlignCenter:true,slidesSpacing:0,loop:false,loopRewind:true,numImagesToPreload:3,autoScaleSlider:true,autoScaleSliderWidth:680,autoScaleSliderHeight:345});inputFunc($("#txt_SearchText"));$(".search-btn").click(function(){var o=$(".search-input").val();var n=$(".search-input").attr("placeholder");if(!!o==false||o==n){alert("请输入检索内容！");return false}selectedValue=$("#DBFieldBox .sort-default span").text();var l=a(1);if(l=="qa"){window.open("http://qa.cnki.net/web/query?q="+encodeURIComponent(o));return false}if(l=="CRDD"){window.open("http://cidian.cnki.net/cidian/Search/SimpleSearch?key="+encodeURIComponent(o)+"&range=CNKIDICT&searchtype=Entryword");return false}if(l=="IMAGE"){window.open("http://image.cnki.net/Result.aspx?n="+encodeURIComponent(o));return false}if(l=="CSYD"){window.open("http://data.cnki.net/Search/ItemSearch?data="+encodeURIComponent(JSON.stringify({keyword:o,albumcode:[]}))+"&f="+encodeURIComponent("kns"));return false}if(l=="CRFD"){window.open("http://gongjushu.cnki.net/RBook/Search/SimpleSearch?range=TOTAL&opt=0&key="+encodeURIComponent(o));return false}if(l=="METHOD"){window.open("http://method.cnki.net/SearchResult.aspx?keyword="+encodeURIComponent(o)+"&option=0");return false}if(l=="CONC"){window.open("http://concept.cnki.net/search_result.aspx?keyword="+encodeURIComponent(o));return false}if(l=="CRLD"){var m="http://ref.cnki.net/REF/AdvSearch/Index?colName="+encodeURIComponent(selectedValue)+"&colValue="+encodeURIComponent(o)+"&isJump=true";if($("#userid").length>0){m=m+"&uid="+$("#userid").val()}window.open(m);return false}if(!!l==false){alert("请选择数据库！");return false}c(l,o)});function d(l,m){if(l&&m){l=l.toUpperCase();var n="SCOD,CISD,SNAD";if(n.indexOf(l)>=0){if(m.indexOf("SU")>=0){return m.replace("SU","FT")}}}return m}function c(s,m){var q=0;q=$(".sort-list .cur").attr("field");var l="//kns.cnki.net/kns/brief/default_result.aspx";var t=s.indexOf(",")>0?"SCDB":s;var r={txt_1_sel:q,txt_1_value1:m,txt_1_special1:"%",txt_extension:"",currentid:"txt_1_value1",dbJson:"coreJson",dbPrefix:t,db_opt:a(),singleDB:t,db_codes:s,singleDBName:"",againConfigJson:false,action:"scdbsearch",ua:"1.11"};var n=$("#formpost");if(n.length==0){n=$("<form id='formpost'></form>")}else{$("#formpost").html("")}n.attr("action",l);n.attr("method","post");n.attr("target","_self");var o;for(o in r){var p=$("<input type='hidden' name='"+o+"' />");p.attr("value",r[o]);n.append(p)}n.appendTo("body");n.css("display","none");n.submit()}$(".search-input").bind("keydown",function(l){if(l.which==13){l.preventDefault();$(".search-btn").click();return false}});$("#highSearch").click(function(){var l=a(1);if(l=="CIDX"){var m="//kns.cnki.net/kns/brief/default_result.aspx?code=CIDX";var o=$(".search-input").val();var n=$(".search-input").attr("placeholder");if(!!o==true&&o!=n){m="//kns.cnki.net/kns/brief/default_result.aspx?code=CIDX&kw="+encodeURIComponent(o)}window.open(m);return false}if(l=="qa"||l.indexOf(",")>0){window.open("//kns.cnki.net/kns/brief/result.aspx?dbprefix=SCDB&crossDbcodes="+l)}else{if(l=="CRLD"){window.open("http://ref.cnki.net/REF/AdvSearch")}else{window.open("//kns.cnki.net/kns/brief/result.aspx?dbprefix="+encodeURIComponent(l))}}return false});function a(m){var n="";var o=".option-list .wx li.selected";var p=$(".searchmain .search-tab .on").attr("val");if(!!p&&p=="ele"){o=".option-list .zsy li.selected"}else{if(!!p&&p=="ref"){o=""}}var l=0;if(!!o){$(o).each(function(r){var q=$(this).attr("val");if(!!q){l++;n=n+","+q}})}if(n.length>1){n=n.substring(1,n.length)}if(!!p&&p=="ref"){n="CRLD"}if(m){if(n.toUpperCase()=="CDFD,CMFD"&&l==1){n="CDMD"}else{if(n.toUpperCase()=="CPFD,IPFD"&&l==1){n="CIPD"}}}if(n.indexOf(",")>0&&n.indexOf("CJFQ")>=0){n=n+",CCJD"}return n}});function isLoginByCookie(){var a=false;if(getUInfoFromECP("uname")!=""){a=true}return a}function IpLogin(){$.ajax({url:"//login.cnki.net/toplogin/api/loginapi/IpLogin2",type:"get",dataType:"jsonp",jsonp:"callback",success:function(a){if(a==1){FlushLogin();modifyEcpHeaderN()}},error:function(){}})}function setLoginState(){if(isLoginByCookie()){FlushLogin();modifyEcpHeaderN()}else{var a=$.cookie("Ecp_lout");if(a!="1"){IpLogin()}}}function getUInfoFromECP(o){if(!o){return""}var ecpjosn=GetCookie("Ecp_LoginStuts");if(ecpjosn){ecpjosn=decodeURIComponent(ecpjosn);var ecpjosntype=eval("("+ecpjosn+")");switch(o){case"uname":return ecpjosntype.UserName;case"utype":return ecpjosntype.UserType;case"sname":return decodeURI(decodeURIComponent(ecpjosntype.ShowName));case"buname":return ecpjosntype.BUserName;case"butype":return ecpjosntype.BUserType;case"bsname":return decodeURI(decodeURIComponent(ecpjosntype.BShowName));default:return""}}return""}function GetCookie(a){var b="[;]*[s]*"+a+"=([^;]*)";var c=new RegExp(b);if(c.test(document.cookie)){return RegExp["$1"]}else{return""}}function modifyEcpHeaderN(){$(".ecp_tn-nav").remove();$("#Ecp_header_mycnki").remove();var b="https://ishufang.cnki.net/KPC?t="+Math.random();var c="http://elib.cnki.net/logindigital.aspx?action=single&p="+getUInfoFromECP("buname")+"&uid="+GetCookie("LID");var a="<li><a id='Ecp_GrsfLink' href="+b+" title='个人书房' target='_blank'>个人书房</a></li>";var d="<li><a id='Ecp_JggLink' href="+c+" title='我的机构馆' target='_blank'>我的机构馆</a></li>";if($("#Ecp_MycnkiLink").length>0){$("#Ecp_GrsfLink").remove();$("#Ecp_MycnkiLink").parent().before(a)}if($("#Ecp_top_logoutJgClick1").length>0){$("#Ecp_JggLink").remove();$("#Ecp_top_logoutJgClick1").parent().before(d)}if(!isLoginByCookie()){updateLoginBut()}}function updateLoginBut(){loginHtml="<a class='ecp_tn-tab' target='_self' href='https://login.cnki.net/login/?platform=kns&ForceReLogin=1&ReturnURL=https://www.cnki.net/'><i>登录</i></a>";$("#Ecp_top_login_div21").hide();$("#Ecp_top_login_div2").hide();$("#Ecp_header_Register").before("<div class='ecp_tn-title'>"+loginHtml+"  </div>")}function Ecp_LogoutOptr(a){updateLoginBut()}function defaultLoadPageJsonInfo(){var a=$("#curdbcode").val();FillSearchSelect(a)}function FillSearchSelect(e){var f=$("#DBFieldList li.cur a").text();var h="";var g=$("#DBFieldList");if(g){if(!!fieldJson){var d=null;for(var a=0;a<fieldJson.length;a++){if(fieldJson[a].key==e){d=fieldJson[a];break}}$(g).empty();if(d){h=d.value[0].key;var c=d.value.length;for(var b=0;b<c;b++){addOptionToUl(g,d.value[b].value,d.value[b].key,b)}SetLiSelected(g,f)}}}SetSelect()}function addOptionToUl(d,c,b,e){var f=$(d);if(f&&b!=""){var a="";if(e==0){a='<li class="cur" val="'+e+'" field="'+c+'"><a href="javascript:void(0);">'+b+"</a></li>"}else{a='<li val="'+e+'" field="'+c+'"><a href="javascript:void(0);">'+b+"</a></li>"}f.append(a)}}function SetLiSelected(a,c){$(a).parent().show();var d=$(a).find("li");if(!!d==false){return false}d.removeClass("cur");var b=d.first();if(b){b.addClass("cur");$("#DBFieldBox .sort-default span").text(b.find("a").text());$("#txt_sug").val(b.find("a").text())}else{$(a).parent().hide()}}function SetSelect(){var a=$("#DBFieldList");if(a==undefined){return false}if(!!a.find("li")==false||a.find("li").length<=0){$("#DBFieldBox").hide();$(".input-box").addClass("fullinput")}else{$("#DBFieldBox").show();$(".input-box").removeClass("fullinput")}}function CrossDb(a){$("#txt_SearchText").attr("placeholder","中文文献、外文文献");if($(a).is(".selected")){ClearExpertPart()}GetSelectDb(a);defaultLoadPageJsonInfo();inputFunc($("#txt_SearchText"))}function ClearExpertPart(){$("#WWBD").removeClass("selected");$("#GXDB").removeClass("selected");$("#CLKD").removeClass("selected");$("#gwkt,#scef,#kjbg,#cgxx").removeClass("selected")}function SingleDb(d){$(".input-box").removeClass("fullinput");var b=".option-list .wx";var c=$(".searchmain .search-tab .on").attr("val");if(!!c&&c=="ele"){$("#txt_SearchText").attr("placeholder","");b=".option-list .zsy"}else{if(!!c&&c=="ref"){$("#txt_SearchText").attr("placeholder","请输入被引文献的特征词");b=""}else{$("#txt_SearchText").attr("placeholder","中文文献、外文文献")}}if($(d).is(".selected")){$(b).find("li").not($(d)).removeClass("selected")}GetSelectDb(d);defaultLoadPageJsonInfo();var a=$("#curdbcode").val();if(a=="qa"){$(".input-box").addClass("fullinput");$("#txt_SearchText").attr("placeholder","请输入您的问题（支持自然语言或关键词提问，自动从文献挖掘答案）")}else{if(a=="IMAGE"){$(".input-box").addClass("fullinput");$("#txt_SearchText").attr("placeholder","图片检索，请输入关键词")}else{if(a=="CSYD"){$(".input-box").addClass("fullinput");$("#txt_SearchText").attr("placeholder",'请输入关键词，系统自动过滤特殊字符 | + %  < > & " ')}else{if(a=="METHOD"){$(".input-box").removeClass("fullinput");$("#txt_SearchText").attr("placeholder","例：情景教学法")}else{if(a=="CONC"){$(".input-box").addClass("fullinput");$("#txt_SearchText").attr("placeholder","")}else{$("#txt_SearchText").attr("placeholder","")}}}}}inputFunc($("#txt_SearchText"))}function LinkDb(b,a){$("#gwkt,#scef,#kjbg,#cgxx").removeClass("selected");$("#ywk").addClass("selected");window.open(a)}function GetSelectDb(c){var a=$(c).parent().find(".selected");if(!!a&&a.length>1){$("#curdbcode").val("SCDB")}else{if(!!a&&a.length==1){var b=a.attr("id");$("#curdbcode").val(b)}else{$("#curdbcode").val("")}}}function inputFunc(a){setInput(a,"#7d7d7d",a.attr("placeholder"));a.focus(function(){setInput(a,"#000","")}).blur(function(){setInput(a,"#7d7d7d",a.attr("placeholder"))})}function setInput(a,b,c){var h="中文文献、外文文献";var j="请输入您的问题（支持自然语言或关键词提问，自动从文献挖掘答案）";var e="请输入被引文献的特征词";var f="图片检索，请输入关键词";var d='请输入关键词，系统自动过滤特殊字符 | + %  < > & " ';var g="例：情景教学法";if(a.val()==""||a.val()==h||a.val()==j||a.val()==e||a.val()==f||a.val()==d||a.val()==g){a.css("color",b);a.val(c)}}function CheckTerminalType(){try{var a=document.referrer;if(a&&a.toLowerCase().indexOf("wap.cnki.net")>-1){return}var d=navigator.userAgent;var b=d.toLowerCase();if(b.indexOf("android")>-1||b.indexOf("iphone")>-1){location.href="http://wap.cnki.net/touch/web/guide"}}catch(c){}};